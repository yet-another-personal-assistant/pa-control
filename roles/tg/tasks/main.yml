---
- name: get pa-tg source (local checkout)
  local_action:
    module: git
    repo: https://gitlab.com/personal-assistant-bot/infrastructure/pa-tg.git
    version: "{{ tg_version }}"
    dest: tmp/pa-tg
  register: tg

- name: upload new source
  block:
  - name: upload pa-tg source
    synchronize:
      src: tmp/pa-tg/
      dest: /var/pa
      delete: yes
    notify: restart server
    notify: update installed tg hash

  - name: install dependencies
    pip:
      requirements: /var/pa/requirements.txt
  when: ansible_local.tg.tg_hash != tg.after

- name: upload service file
  copy:
    src: files/pa.service
    dest: /etc/systemd/system/
  notify: reload systemd unit

- name: upload token file
  copy:
    src: files/token.txt
    dest: /var/pa-token.txt
  notify: restart server

- name: ensure service is started
  service:
    name: pa
    state: started
    enabled: yes